<source>
  @type    tail
  format   ltsv
  path     /var/log/nginx/access_ltsv.log
  pos_file /var/log/td-agent/buffer/access_ltsv.log.pos
  tag      nginx.access
</source>

<match nginx.access>
  @type copy

  ## ログ流量監視をするために out_flowcounter にも送る
  <store>
    @type      flowcounter
    count_keys *
    unit       second
    aggregate  all
    tag        fluentd.flowcounter.nginx.access
    @label     @dogstatsd
  </store>

  ## @nginx にルーティングする
  <store>
    @type  relabel
    @label @nginx
  </store>
</match>

<label @nginx>
  ## out_record_reformer で目的に応じてレコードを整形する
  <match nginx.access>
    @type copy

    # access_ltsv.logのrequest_uriで集計する
    <store>
      @type record_reformer
      renew_record true
      enable_ruby  true
      tag dogstatsd.increment
      <record>
        type "increment"
        key  "custom.nginx.request_count"
        method        ${record["method"]}
        uri           ${record["uri"]}
        uri_formatted ${record["uri"].gsub(%r{(?<=/)[0-9]+(?=(/|$|\.))}, ":id")}
        status        ${record["status"]}
        status_class  ${record["status"].to_i / 100}XX
      </record>
    </store>
  </match>

  ## @dogstatsd にルーティングする
  <match dogstatsd.**>
    @type  relabel
    @label @dogstatsd
  </match>
</label>
