[mysqld_safe]
log_error = /var/log/mysql/error.log

[mysqld]
log_error = /var/log/mysql/error.log

max_connections=3000

# MySQL server has gone away対策
max_allowed_packet = 1000M
connect_timeout = 60

# デフォルトが127.0.0.1なのを変える
bind-address  = 0.0.0.0
# mysqlx-bind-address = 0.0.0.0

innodb_file_per_table = ON
innodb_flush_method=O_DIRECT

# 物理メモリの8割
# innodb_buffer_pool_size = <%= @innodb_buffer_pool_size_mb %>M

# innodb_buffer_pool_sizeの1/4程度
# innodb_log_file_size = <%= @innodb_log_file_size_mb %>M

# TODO: ログを止める場合はlog_errorもコメントアウトする
# general-log = 0

<% if @slow_query_log_file && @long_query_time %>
# Enable the slow query log to see queries with especially long duration
slow_query_log         = on
slow_query_log_file    = <%= @slow_query_log_file %>
long_query_time        = <%= @long_query_time %>
#log_slow_rate_limit    = 1000
#log_slow_verbosity     = query_plan
#log-queries-not-using-indexes
<% end %>

# c.f. https://docs.datadoghq.com/ja/database_monitoring/setup_mysql/selfhosted/
<% if @mysql_short_version >= 5.7 %>
performance_schema = ON
max_digest_length  = 4096
performance_schema_max_digest_length   = 4096

# NOTE: MariaDBだとエラーになるのでコメントアウト
# performance_schema_max_sql_text_length = 4096

performance-schema-consumer-events-statements-current      = ON
performance-schema-consumer-events-statements-history-long = ON
performance-schema-consumer-events-statements-history      = ON
<% end %>
